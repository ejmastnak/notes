---
title: "MuscleSync"
date: "2025-09-14"
---

<script setup>
import Image from '@/Components/Image.vue'

import brokenMotorImg from './img/broken-motor-lead.jpg?w=600'
import derivativeImg from './img/derivative-filt.jpg'
import rawImg from './img/raw.jpg'
import regionsImg from './img/regions-filt.jpg'
import regionsEqualizedImg from './img/regions-filt-equalized.jpg'
import vibrationSetupImg from './img/vibration-setup.jpg?w=800'

</script>

# MuscleSync: 2025-09-15 update

This is an analysis of the measurements performed on 2025-09-05.
I'm placing a summary with useful takeaways first, and then placing the report after:

## Takeaways and summary

- Filtering with 10 Hz, 5-th order Butterworth lowpass filter appears to work well as preprocessing step, and is well-suited for adaptation to a real-time approach on embedded hardware.
- From measurements so far, MC signal amplitude is relatively constant across maximum, target, and light muscle output (and not considerably larger during maximum muscle output as we might have initially expected). This complicates classification of muscle output into max/target/light regions—i.e. we can't just say "large amplitude = larger muscle output".
- In our measurements so far, higher muscle output was correlated to higher cadence, since we also pedalled faster when pedalling harder. Although cadence is easy to measure, we need to make sure our classification algorithm does not "cheat" by using cadence as a proxy for muscle output—i.e. we need to robustly distinguish between cadence and muscle output.
- Integration (area under the curve after bias correction) is not (for the measurements so far) a reliable discriminator of muscle output. See discussion below.
- Differentiation (for the measurements so far) is a *strong* discriminator of muscle output, and is the most promising discriminator so far. However, this could be simply because of higher cadence at higher output, and more measurements are needed. See discussion below.
- **Next step:** take measurements at high cadence but minimum resistance (which should require relatively light muscle output), and compare to measurements at maximum cadence but lower cadence (which should require considerably higher muscle output because of the high resistance). 
  Use this to test robustness of classification methods to high cadence but low output, particularly derivative-based classification.

## Measurements

We performed initial MC sensor measurements on a stationary bike the previous week.
This section shows an initial analysis of the measurements; the goal is to find characteristics that distinguish maximum, target, and below-target muscle output.

We measured both Elijan and Alma.
But during Alma's measurement, we forgot to take the baseline reading with an extended leg. That makes accurate bias correction difficult, so for this initial analysis I used only Elijan's signal.

### Measurement protocol

For repeatability of future measurements, here is the measurement protocol:

- Equipment: stationary bike at Srdjan's apartment at Rimska 12
- Upor: MAX
- Seat height: setting 63
- Take baseline reading (for the purposes of computing MC sensor bias) with leg extended (i.e. with no tension in leg)
- Acquisition: sampled at 1 kHz with MC data logger on channel 1
- Sequence:
  1. maximum muscle output for 10 seconds; rest 5-10 seconds
  1. 80% maximum output (self-assessed) for 10 seconds; rest 5-10 seconds
  1. "Light" output (self-assessed) for 10 seconds

I will be calling the three regions "Max", "Target", and "Light" in the rest of this page.

### Measurement data

Measurement files (CSV download):

- [Raw signal](/musclesync/csv/mc-2025-09-05.csv)
- [Filtered signal](/musclesync/csv/mc-filt-2025-09-05.csv), filtered with a 5th order Butterworth lowpass filter with a 10 Hz cutoff frequency, computed with second-order-sections

#### MC signal

Below is the raw MC signal, before filtering or bias correction:

<Image :src="rawImg" caption='The raw MC signal, before filtering or bias correction. The sequence is maximum output, 80% (self-assessed) maximum output, and "light" output. Note that cadence is considerably higher at higher output, but that the MC signal amplitude is relatively consistent throughout.' />

I split the signal into regions of maximum, target, and light output as follows:

| Region | Start time [s] | Stop time [s] |
| - | - | - |
| Max | 4.2 | 14.6 |
| Target | 18.5 | 33.4 |
| Light | 36.8 | 50.0 |

I used the average MC signal value in the region from 0.0 to 2.0 seconds for bias correction. 

#### MC signal in each region

Below is the MC signal after bias correction and filtering, split into the three output regions for easier comparison.
Again, note the higher cadence, but not necessarily higher amplitude, in the higher-output signals.

Of note: the maximum-output signal never appears to quite return to baseline, as if the muscle does not fully relax (note how the minima of the max-output signal are erratic and narrow, and grow progressively better-defined as muscle output deceases).
This trend should be examined further in future measurements as a possible distinguishing characteristic of muscle output range.

<Image :src="regionsImg" caption='The MC signal after bias correction and filtering, split into max, target, and light output.' />

Below are the same three regions, but with only the first 10 seconds shown, on the same scale, for better comparision.

<Image :src="regionsEqualizedImg" caption='The first 10 seconds of the three muscle output regions, shown on the same time scale for easier comparison.' />

#### Integration-based analysis

One proposed algorithm by Srdjan for distinguishing max, target, and light output was to take the integral over time of the bias-corrected signal in each region.

Here are integrals of each region, (computed using the trapezoidal rule after bias correction), both for the raw and filtered signals:

| Region | Integral of raw signal |  Integral of filtered signal |
| - | - | - |
| Max | 5.432 | 5.431 |
| Target | 8.114 | 8.112 |
| Light | 7.604 | 7.604 |

At least initially, there is unfortunately no correlation between muscle output and integral value—in fact, the maximum output has the decidedly lowest integral (as suggested by the plots of the MC signal in each region, where the max signal indeed seems to have the smallest area under the curve).

One might expect the max-output signal would have a larger integral because of larger maximum muscle amplitude, but it seems the higher cadence and correspondingly faster decreases in amplitude more than compensate for this.

More measurements are needed, but it seems, at least initially, that simple integration won't reliably distinguish muscle output.

#### Differentiation-based analysis

The idea with differentiation-based analysis is to see if we can use the obviously sharper rates of change in the max output signal to distinguish maximum, target, and light output.

Below are the derivatives of the filtered MC signal (computed with second-order accurate finite differences) in the maximum, target, and light-output regions.
Here the difference between each region is dramatic—amplitudes of the derivative in the maximum output region are about 3 times larger than in the target output region, and nearly 10 times larger than in the light output region.
Obviously a portion of the higher amplitude in the maximum output region is due to higher cadence than the other regions rather than "greater muscle output" per se.

An important next step is to see how much of the large derivative amplitude at maximum output is due to high cadence in this specific measurement session, and how much to truly different contractile behavior at high output.
This needs to be investigated in the next measurement session by testing the MC signal at high cadence and light load, and comparing to low cadence at high load.

<Image :src="derivativeImg" caption='The derivative of the filtered MC signal in each region. Note the *dramatically* larger amplitudes at higher muscle output—some of this is due to higher cadence, but some might be due to bona fide faster contraction at high output, and could be used to distinguish muscle output regions.' />

## Effect of vibration on MC sensor

TLDR: more hardware problems; initial tests suggest lowpass filtering solves vibration-induced noise; will give a conclusive take after more measurements.

From preliminary tests it looks like haptic motor vibration (high frequency—above 100 Hz) can be reliably filtered out with a cca 10 Hz, cca 5th order IIR lowpass filter without affecting the MC signal, which might have *maximum* 5 Hz components at *very* fast pedalling.
The large frequency difference between meaningful muscle signals and the haptic motor vibration plays to our advantage here.

<Image :src="vibrationSetupImg" caption="Setup for testing effect of vibration on MC signal." />

Unfortunately the positive motor lead broke as I began to take measurements.
It is a simple fix, but I am away from home this weekend without a soldering station, which I need to make the repair (going forward, I will attach a longer and thicker wire than what the manufacturer provided to relieve strain at the solder joint connecting the motor lead to the haptic driver).

<Image :src="brokenMotorImg" caption="The positive motor lead (red wire) needs to be reattached to the haptic driver's positive output. I will do this back in Ljubljana where I have a soldering station." />

Here is the protocol I am using so far:

- MC sensor taped to my left vastus lateralis, haptic motor placed over MC sensor for maximum effect (in practice the motor would probably be to the side of the MC sensor, which would produce less interference) taking measurements next to vibrating haptic motor.
- With MC sensor recording, haptic motor iterates through waveforms 1 through 123 of the DRV2605L waveform library (see page 60 of DRV2605L datasheet); the idea is to use many different waveforms to get as much data as possible on the effect of vibration on MC signal acquisition.
- With MC sensor recording, contract/release vastus lateralis contracts/relaxes at 80 bpm, measured with a metronome, (80 bpm parallels target cycling cadence) for e.g. 10 repetitions.
- Repeat without haptic motor vibrating; same sensor position contract/release protocol.

Analysis: compare raw MC sensor reading with and without vibrating haptic motor; repeat analysis using MC signal filtered at with a 5th order Butterworth lowpass filter with 10 Hz cutoff.


